@startuml runtime-bundle-architecture

!include ../aws.pu

title Runtime-loaded Bundle Artifact â€” High-level Architecture

skinparam shadowing false
skinparam linetype ortho
skinparam packageStyle rectangle
skinparam componentStyle rectangle
skinparam defaultFontSize 12
hide stereotype

left to right direction

actor Dev as "Developer"

rectangle "Dev Machine\nCLI / SDK" as CLI {
}

cloud "Control Plane" as CP

SimpleStorageService(REG, "Bundle Registry", "S3", "Signed bundle artifacts")

frame "Hosted Engine Service" as Engine {
  [Bundle Loader] as Loader
  [Sandbox (SES/WASM)] as Sandbox
  [Orchestrator] as Orchestrator
  database "BlockIndex" as BlockIdx
  database "Entities Store" as Entities
  rectangle "Outbox" as Outbox
}

cloud "Source Systems" as Sources

frame "Tenant Destinations" as Dest {
  [Webhook Endpoint] as Webhook
  [Other Sinks (optional)] as Sinks
}

' Control plane
Dev --> CLI : author bundle
CLI --> CLI : validate
CLI --> CP : publish
CP --> REG : store
CP --> Engine : activate
Engine --> Loader : load
Loader --> Sandbox : compile/cache

' Data plane
Sources --> Orchestrator : ingest
Orchestrator --> Sandbox : decide
Sandbox --> Orchestrator : result
Orchestrator --> BlockIdx : index
Orchestrator --> Entities : upsert
Orchestrator --> Outbox : enqueue
Outbox --> Webhook : deliver (HMAC)
Outbox ..> Sinks : optional

' Governance & observability
Dest --> Orchestrator : overrides
Engine ..> CLI : trace / shadow / metrics

@enduml